<html>
    <head>
        <title>Uploads</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    </head>
    <body>  
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <ul class=flashes>
                {% for message in messages %}
                <li>{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %} 
        <h1>Example link <a href="https://www.jianshu.com/p/716d470d6434">使用 Flask-Uploads + jQuery + Bootstrap 创建带进度条的文件上传 </a></h1>     
        <form action= "{{ url_for('upload') }}" method="POST" enctype="multipart/form-data">
            <input type="file" name="thefile" id="fileupload">
            <input type="submit" >
        </form>
        <div class="progress" style="display: none;">
            <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                0%
            </div>
        </div> 
        <script>
        $('form').on('submit', function (event) {
            // 显示进度条
            $('.progress').css('display', 'block');
            // 阻止元素发生默认的行为，此处用来阻止对表单的提交
            event.preventDefault();
            var formData = new FormData(this);
            // jQuery Ajax 上传文件，关键在于设置：processData 和 contentType
            $.ajax({
                xhr: function () {
                    var xhr = new XMLHttpRequest();
                    xhr.upload.addEventListener('progress', function (e) {
                        if (e.lengthComputable) {
                            var percent = Math.round(e.loaded * 100 / e.total);
                            $('.progress-bar').attr('aria-valuenow', percent).css('width', percent + '%').text(percent + '%');
                        }
                    });
                    return xhr;
                },
                type: 'POST',
                url: '/uploads',
                cache: false,
                data: formData,
                // 告诉 jQuery 不要去处理发送的数据
                processData: false,
                // 告诉 jQuery 不要去设置 Content-Type 请求头
                // 因为这里是由 <form> 表单构造的 FormData 对象，且已经声明了属性 enctype="multipart/form-data"，所以设置为 false
                contentType: false
            }).done(function (res) {
                alert('上传成功!');
            }).fail(function (res) {
                alert('上传失败!');
            });
        });
        </script>        
    </body>
</html>    